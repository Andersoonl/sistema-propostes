generator client {
  provider = "prisma-client"
  output   = "../app/generated/prisma"
}

datasource db {
  provider = "sqlite"
}

// Máquinas fixas: VP1, VP2, HZEN
model Machine {
  id              String           @id @default(cuid())
  name            String           @unique
  productionDays  ProductionDay[]
  shiftOverrides  ShiftOverride[]
  downtimeReasons DowntimeReason[]
  shifts          MachineShift[]
  createdAt       DateTime         @default(now())
}

// Configuração de turno por máquina e dia da semana
model MachineShift {
  id           String   @id @default(cuid())
  machineId    String
  machine      Machine  @relation(fields: [machineId], references: [id], onDelete: Cascade)
  dayOfWeek    Int      // 0=Domingo, 1=Segunda, ..., 6=Sábado
  startTime    String   // HH:mm
  endTime      String   // HH:mm
  breakMinutes Int      // Pausas em minutos
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@unique([machineId, dayOfWeek])
}

// Produtos que podem ser produzidos
model Product {
  id                 String              @id @default(cuid())
  name               String              @unique
  category           String?             // PISO INTERTRAVADO, BLOCO DE CONCRETO
  subcategory        String?             // PAVER, UNISTEIN, FAMILIA 09, etc.
  productionItems    ProductionItem[]
  costRecipe         CostRecipe?
  inventoryMovements InventoryMovement[]
  palletizations     Palletization[]
  loosePiecesBalance LoosePiecesBalance?
  basePrice          Float?              // Preço base de venda (R$)
  basePriceUnit      QuantityUnit?       // Unidade do preço base (PIECES ou M2)
  quoteItems         QuoteItem[]
  orderItems         OrderItem[]
  productionOrders   ProductionOrder[]
  deliveryItems      DeliveryItem[]
  createdAt          DateTime            @default(now())
}

// Ingredientes/Materiais (dados mestre)
model Ingredient {
  id              String          @id @default(cuid())
  name            String          @unique
  unit            String          // kg, ml, un
  unitPrice       Float           // R$/unidade
  recipeItems     RecipeItem[]
  materialEntries MaterialEntry[]
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
}

// Receita de custo do produto
model CostRecipe {
  id               String       @id @default(cuid())
  productId        String       @unique
  product          Product      @relation(fields: [productId], references: [id], onDelete: Cascade)

  // Parâmetros de produção
  density          Float?       // Densidade média
  piecesPerCycle   Int          // Peças por ciclo
  cyclesPerBatch   Float        // Ciclos por traço
  piecesPerM2      Float        // Peças por m²
  avgPieceWeightKg Float        // Peso médio da peça (kg)
  piecesPerPallet  Int?         // Peças por pallet (blocos)
  m2PerPallet      Float?       // m² por pallet (pisos)

  // Custos extras (R$)
  palletCost       Float        @default(0)
  strappingCost    Float        @default(0)
  plasticCost      Float        @default(0)

  items            RecipeItem[]
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt
}

// Itens da receita (ingrediente + quantidade)
model RecipeItem {
  id           String     @id @default(cuid())
  recipeId     String
  recipe       CostRecipe @relation(fields: [recipeId], references: [id], onDelete: Cascade)
  ingredientId String
  ingredient   Ingredient @relation(fields: [ingredientId], references: [id], onDelete: Cascade)
  quantity     Float      // Quantidade por traço
  createdAt    DateTime   @default(now())

  @@unique([recipeId, ingredientId])
}

// Override de turno por dia e máquina (casos raros)
model ShiftOverride {
  id              String   @id @default(cuid())
  machineId       String
  machine         Machine  @relation(fields: [machineId], references: [id], onDelete: Cascade)
  date            DateTime
  startTime       String   // HH:mm
  endTime         String   // HH:mm
  breakMinutes    Int      // Pausas em minutos
  createdAt       DateTime @default(now())

  @@unique([machineId, date])
}

// Dia de produção (um registro por máquina por dia)
model ProductionDay {
  id              String           @id @default(cuid())
  machineId       String
  machine         Machine          @relation(fields: [machineId], references: [id], onDelete: Cascade)
  date            DateTime
  hasProductSwap  Boolean          @default(false) // Troca de produto?
  notes           String?
  productionItems ProductionItem[]
  downtimeEvents  DowntimeEvent[]
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  @@unique([machineId, date])
}

// Item de produção (produto + ciclos)
// Máximo 2 por dia por máquina
model ProductionItem {
  id              String        @id @default(cuid())
  productionDayId String
  productionDay   ProductionDay @relation(fields: [productionDayId], references: [id], onDelete: Cascade)
  productId       String
  product         Product       @relation(fields: [productId], references: [id], onDelete: Cascade)
  cycles          Int           // Quantidade de ciclos
  pieces          Int?          // Peças produzidas (calculado: ciclos * piecesPerCycle da receita)
  pallets         Float?        // Pallets (calculado: peças / piecesPerPallet)
  areaM2          Float?        // m² (calculado: peças / piecesPerM2)
  startTime       String?       // HH:mm (opcional)
  endTime         String?       // HH:mm (opcional)
  createdAt       DateTime      @default(now())

  @@unique([productionDayId, productId])
}

// Motivos de parada (hierarquia NV1 -> NV2 -> NV3)
model DowntimeReason {
  id             String           @id @default(cuid())
  name           String
  level          Int              // 1, 2, or 3
  parentId       String?
  parent         DowntimeReason?  @relation("ReasonHierarchy", fields: [parentId], references: [id], onDelete: Cascade)
  children       DowntimeReason[] @relation("ReasonHierarchy")
  machineId      String?
  machine        Machine?         @relation(fields: [machineId], references: [id], onDelete: Cascade)
  downtimeEvents DowntimeEvent[]
  createdAt      DateTime         @default(now())

  @@unique([name, level, parentId, machineId])
}

// Evento de parada
model DowntimeEvent {
  id              String         @id @default(cuid())
  productionDayId String
  productionDay   ProductionDay  @relation(fields: [productionDayId], references: [id], onDelete: Cascade)
  reasonId        String         // Motivo (NV1, NV2 ou NV3)
  reason          DowntimeReason @relation(fields: [reasonId], references: [id], onDelete: Cascade)
  durationMinutes Int            // Duração em minutos
  notes           String?        // Observação opcional
  createdAt       DateTime       @default(now())
}

// Entrada de matéria prima (compras)
model MaterialEntry {
  id            String     @id @default(cuid())
  ingredientId  String
  ingredient    Ingredient @relation(fields: [ingredientId], references: [id], onDelete: Cascade)
  date          DateTime
  quantity      Float      // quantidade comprada
  unitPrice     Float      // preço unitário na compra
  supplier      String?    // fornecedor (legado, texto livre)
  supplierId    String?    // FK para cadastro de fornecedor
  supplierRef   Supplier?  @relation(fields: [supplierId], references: [id], onDelete: SetNull)
  invoiceNumber String?    // número NF
  notes         String?
  payable       Payable?
  createdAt     DateTime   @default(now())
}

// Status do cliente
enum CustomerStatus {
  ACTIVE
  INACTIVE
}

// Cadastro de clientes
model Customer {
  id                String         @id @default(cuid())
  companyName       String         // Razão social
  tradeName         String?        // Nome fantasia
  document          String         @unique // Apenas dígitos (11=CPF, 14=CNPJ)
  documentType      String         // "CNPJ" ou "CPF"
  stateRegistration String?        // Inscrição estadual
  zipCode           String?        // CEP
  street            String?        // Logradouro
  number            String?        // Número
  complement        String?        // Complemento
  neighborhood      String?        // Bairro
  city              String?        // Cidade
  state             String?        // UF (2 letras)
  phone             String?        // Telefone
  email             String?        // Email
  contactName       String?        // Contato principal
  notes             String?        // Observações
  status            CustomerStatus @default(ACTIVE)
  quotes            Quote[]
  orders            Order[]
  receivables       Receivable[]
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
}

// Status do fornecedor
enum SupplierStatus {
  ACTIVE
  INACTIVE
}

// Cadastro de fornecedores
model Supplier {
  id                String         @id @default(cuid())
  companyName       String         // Razão social
  tradeName         String?        // Nome fantasia
  document          String         @unique // Apenas dígitos (11=CPF, 14=CNPJ)
  documentType      String         // "CNPJ" ou "CPF"
  stateRegistration String?        // Inscrição estadual
  zipCode           String?        // CEP
  street            String?        // Logradouro
  number            String?        // Número
  complement        String?        // Complemento
  neighborhood      String?        // Bairro
  city              String?        // Cidade
  state             String?        // UF (2 letras)
  phone             String?        // Telefone
  email             String?        // Email
  contactName       String?        // Contato principal
  notes             String?        // Observações
  status            SupplierStatus @default(ACTIVE)
  payables          Payable[]
  materialEntries   MaterialEntry[]
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
}

// Movimentação de estoque de produto acabado
model InventoryMovement {
  id              String   @id @default(cuid())
  productId       String
  product         Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  date            DateTime
  type            String   // 'IN' (paletização ou legado) ou 'OUT' (saída/venda)
  quantityPieces  Int
  quantityPallets Float?
  areaM2          Float?
  notes           String?
  productionDayId String?  // referência ao dia de produção (legado, antes da paletização)
  palletizationId String?  // referência à paletização (quando entrada gerada pela paletização)
  deliveryId      String?  // referência à entrega (quando saída gerada pela entrega)
  createdAt       DateTime @default(now())
}

// Confirmação de paletização (contagem real pós-cura)
model Palletization {
  id                String   @id @default(cuid())
  productId         String
  product           Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  productionDate    DateTime // dia em que foi produzido (D)
  palletizedDate    DateTime // dia em que foi paletizado (D+1 útil ou posterior)

  theoreticalPieces Int      // total teórico (soma dos ProductionItem do dia para este produto)
  completePallets   Int      // input do operador: pallets completos
  loosePiecesAfter  Int      // input do operador: peças soltas restantes
  piecesPerPallet   Int      // snapshot da receita no momento da paletização

  realPieces        Int      // calculado: completePallets × piecesPerPallet
  lossPieces        Int      // calculado: theoreticalPieces + loosePiecesBefore - realPieces - loosePiecesAfter
  loosePiecesBefore Int      // peças soltas acumuladas ANTES desta paletização

  notes             String?
  createdAt         DateTime @default(now())

  @@unique([productId, productionDate])
}

// Saldo corrente de peças soltas por produto
model LoosePiecesBalance {
  id        String   @id @default(cuid())
  productId String   @unique
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  pieces    Int      @default(0)
  updatedAt DateTime @updatedAt
}

// ===== MÓDULO ORDENS DE PRODUÇÃO =====

enum ProductionOrderStatus {
  PENDING       // Aguardando produção
  IN_PROGRESS   // Estoque parcial (0 < disponível < necessário)
  COMPLETED     // Estoque >= necessário
  CANCELLED     // Cancelada
}

model ProductionOrder {
  id              String                @id @default(cuid())
  number          Int                   @unique // Sequencial (OP-0001)
  orderId         String
  order           Order                 @relation(fields: [orderId], references: [id], onDelete: Restrict)
  orderItemId     String                @unique
  orderItem       OrderItem             @relation(fields: [orderItemId], references: [id], onDelete: Restrict)
  productId       String
  product         Product               @relation(fields: [productId], references: [id], onDelete: Restrict)
  quantityPieces  Int                   // Quantidade total necessária (sempre em peças)
  stockAtCreation Int                   // Snapshot: estoque disponível no momento da criação
  toProducePieces Int                   // quantityPieces - stockAtCreation (o que falta produzir)
  status          ProductionOrderStatus @default(PENDING)
  notes           String?
  completedAt     DateTime?
  createdAt       DateTime              @default(now())
  updatedAt       DateTime              @updatedAt
}

// ===== MÓDULO COMERCIAL =====

enum QuoteStatus {
  DRAFT
  SENT
  APPROVED
  REJECTED
  EXPIRED
}

enum OrderStatus {
  CONFIRMED
  IN_PRODUCTION
  READY
  DELIVERED
  CANCELLED
}

enum QuantityUnit {
  PIECES
  M2
}

// Orçamento
model Quote {
  id               String      @id @default(cuid())
  number           Int         @unique // Sequencial (exibido como ORC-0001)
  customerId       String
  customer         Customer    @relation(fields: [customerId], references: [id], onDelete: Restrict)
  date             DateTime    @default(now())
  validUntil       DateTime
  status           QuoteStatus @default(DRAFT)
  projectName      String?     // Obra/projeto
  paymentTerms     String?     // Prazo de pagamento (ex: 15 dias, 30/60/90)
  paymentMethod    String?     // Forma de pagamento (Boleto, Transferência, PIX)
  deliveryType     String?     // Tipo frete (CIF/FOB)
  deliveryAddress  String?     // Endereço de entrega
  deliverySchedule String?     // Programação entrega (Imediata, 5 dias, etc.)
  notes            String?
  totalAmount      Float       @default(0)
  items            QuoteItem[]
  orders           Order[]
  createdAt        DateTime    @default(now())
  updatedAt        DateTime    @updatedAt
}

// Item do orçamento
model QuoteItem {
  id        String       @id @default(cuid())
  quoteId   String
  quote     Quote        @relation(fields: [quoteId], references: [id], onDelete: Cascade)
  productId String
  product   Product      @relation(fields: [productId], references: [id], onDelete: Restrict)
  quantity  Float
  unit      QuantityUnit
  unitPrice Float
  discount  Float        @default(0) // Desconto em % (0-100)
  subtotal  Float
  createdAt DateTime     @default(now())
}

// Pedido
model Order {
  id           String      @id @default(cuid())
  number       Int         @unique // Sequencial (exibido como PED-0001)
  quoteId      String?     // null = pedido avulso
  quote        Quote?      @relation(fields: [quoteId], references: [id], onDelete: SetNull)
  customerId   String
  customer     Customer    @relation(fields: [customerId], references: [id], onDelete: Restrict)
  orderDate    DateTime    @default(now())
  deliveryDate DateTime?   // Previsão de entrega
  status       OrderStatus @default(CONFIRMED)
  paymentTerms String?
  notes        String?
  totalAmount  Float       @default(0)
  items            OrderItem[]
  productionOrders ProductionOrder[]
  deliveries       Delivery[]
  receivables      Receivable[]
  createdAt        DateTime    @default(now())
  updatedAt        DateTime    @updatedAt
}

// Item do pedido
model OrderItem {
  id              String           @id @default(cuid())
  orderId         String
  order           Order            @relation(fields: [orderId], references: [id], onDelete: Cascade)
  productId       String
  product         Product          @relation(fields: [productId], references: [id], onDelete: Restrict)
  quantity        Float
  unit            QuantityUnit
  unitPrice       Float
  discount        Float            @default(0) // Desconto em % (0-100)
  subtotal        Float
  productionOrder ProductionOrder?
  deliveryItems   DeliveryItem[]
  createdAt       DateTime         @default(now())
}

// ===== MÓDULO LOGÍSTICA =====

enum VehicleStatus {
  ACTIVE
  INACTIVE
}

enum DriverStatus {
  ACTIVE
  INACTIVE
}

enum DeliveryStatus {
  LOADING     // Carregando
  IN_TRANSIT  // Em trânsito
  DELIVERED   // Entregue
  CANCELLED   // Cancelada
}

// Veículos
model Vehicle {
  id          String        @id @default(cuid())
  plate       String        @unique // Placa (ABC-1234 ou ABC1D23)
  description String?       // Descrição (ex: Caminhão Truck)
  capacity    String?       // Capacidade (ex: 12 toneladas)
  status      VehicleStatus @default(ACTIVE)
  deliveries  Delivery[]
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
}

// Motoristas
model Driver {
  id         String       @id @default(cuid())
  name       String
  document   String?      // CPF
  phone      String?
  license    String?      // CNH
  status     DriverStatus @default(ACTIVE)
  deliveries Delivery[]
  createdAt  DateTime     @default(now())
  updatedAt  DateTime     @updatedAt
}

// Entrega
model Delivery {
  id              String         @id @default(cuid())
  number          Int            @unique // Sequencial (ENT-0001)
  orderId         String
  order           Order          @relation(fields: [orderId], references: [id], onDelete: Restrict)
  vehicleId       String?
  vehicle         Vehicle?       @relation(fields: [vehicleId], references: [id], onDelete: SetNull)
  driverId        String?
  driver          Driver?        @relation(fields: [driverId], references: [id], onDelete: SetNull)
  loadingDate     DateTime       // Data de carregamento
  deliveryDate    DateTime?      // Data da entrega (preenchida ao entregar)
  deliveryAddress String?        // Endereço de entrega
  status          DeliveryStatus @default(LOADING)
  notes           String?
  items           DeliveryItem[]
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
}

// Item da entrega
model DeliveryItem {
  id             String    @id @default(cuid())
  deliveryId     String
  delivery       Delivery  @relation(fields: [deliveryId], references: [id], onDelete: Cascade)
  orderItemId    String
  orderItem      OrderItem @relation(fields: [orderItemId], references: [id], onDelete: Restrict)
  productId      String
  product        Product   @relation(fields: [productId], references: [id], onDelete: Restrict)
  quantityPieces Int       // Quantidade em peças
  notes          String?
  createdAt      DateTime  @default(now())
}

// ===== MÓDULO FINANCEIRO =====

enum ReceivableStatus {
  PENDING
  PARTIAL
  PAID
  OVERDUE
  CANCELLED
}

enum PayableStatus {
  PENDING
  PARTIAL
  PAID
  OVERDUE
  CANCELLED
}

enum PayableCategory {
  RAW_MATERIAL  // Matéria-Prima
  ENERGY        // Energia
  MAINTENANCE   // Manutenção
  PAYROLL       // Folha de Pagamento
  TAXES         // Impostos
  OTHER         // Outros
}

// Conta a receber
model Receivable {
  id            String            @id @default(cuid())
  number        Int               @unique // Sequencial (REC-0001)
  orderId       String?
  order         Order?            @relation(fields: [orderId], references: [id], onDelete: SetNull)
  customerId    String
  customer      Customer          @relation(fields: [customerId], references: [id], onDelete: Restrict)
  description   String?
  invoiceNumber String?           // Número da NF
  issueDate     DateTime          // Data de emissão
  dueDate       DateTime          // Data de vencimento
  totalAmount   Float             // Valor total
  paidAmount    Float             @default(0) // Valor já pago
  status        ReceivableStatus  @default(PENDING)
  notes         String?
  payments      ReceivablePayment[]
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt
}

// Pagamento de conta a receber
model ReceivablePayment {
  id            String     @id @default(cuid())
  receivableId  String
  receivable    Receivable @relation(fields: [receivableId], references: [id], onDelete: Cascade)
  paymentDate   DateTime
  amount        Float
  paymentMethod String     // Boleto, PIX, Transferência, Cheque, Dinheiro
  reference     String?    // Nº boleto/comprovante
  notes         String?
  createdAt     DateTime   @default(now())
}

// Conta a pagar
model Payable {
  id              String          @id @default(cuid())
  number          Int             @unique // Sequencial (PAG-0001)
  supplierId      String?
  supplier        Supplier?       @relation(fields: [supplierId], references: [id], onDelete: SetNull)
  materialEntryId String?         @unique
  materialEntry   MaterialEntry?  @relation(fields: [materialEntryId], references: [id], onDelete: SetNull)
  description     String?
  invoiceNumber   String?         // Número da NF
  issueDate       DateTime        // Data de emissão
  dueDate         DateTime        // Data de vencimento
  totalAmount     Float           // Valor total
  paidAmount      Float           @default(0) // Valor já pago
  category        PayableCategory // Categoria da despesa
  status          PayableStatus   @default(PENDING)
  notes           String?
  payments        PayablePayment[]
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
}

// Pagamento de conta a pagar
model PayablePayment {
  id            String   @id @default(cuid())
  payableId     String
  payable       Payable  @relation(fields: [payableId], references: [id], onDelete: Cascade)
  paymentDate   DateTime
  amount        Float
  paymentMethod String   // Boleto, PIX, Transferência, Cheque, Dinheiro
  reference     String?  // Nº boleto/comprovante
  notes         String?
  createdAt     DateTime @default(now())
}
